---
title: "Gafo-cc-analysis"
output: html_document
date: '2022-03-26'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(brms)
library(tidybayes)
library(ggthemes)
```


```{r}
mdata <- read_csv("../data/gafo-cc-clean-data.csv")%>%
  mutate(ageinyears = ageinyears-mean(ageinyears),
         targetcentralityx = scale(targetcentralityx),
         trialnr = scale(trialnr),
         children = scale(children),
         household = scale(household),
         younger_children = scale(younger_children),
         touchscreen = factor(touchscreen.x),
        screen = factor(screen),
        click = abs(clickdistfromtargetcenterx))%>%
  filter(community != "chimfunshi")%>%
  select(subjid,community,ageinyears,children, household, younger_children,trialnr, screen,touchscreen, targetcentralityx, click )


mdata%>%
  ggplot(aes(x = click))+
  geom_density()

```




```{r}
bm_int_id <- brm(click ~ ageinyears  * targetcentralityx + (targetcentralityx+trialnr|subjid) + (ageinyears * targetcentralityx |community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
                 control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))


bm_id <- brm(click ~ ageinyears  + targetcentralityx + (targetcentralityx+trialnr|subjid) + (ageinyears |community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
             control = list(adapt_delta = 0.95),
             backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_int <- brm(click ~ ageinyears  * targetcentralityx + (trialnr|subjid) + (ageinyears * targetcentralityx |community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
              control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_base <- brm(click ~ ageinyears  + targetcentralityx + (trialnr|subjid) + (ageinyears |community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
               control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_nage <- brm(click ~ targetcentralityx + (trialnr|subjid) + (1 |community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
               control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_ntc <- brm(click ~ ageinyears  + (trialnr|subjid) + (ageinyears|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
              control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_co <- brm(click ~ 1 + (trialnr|subjid)+ (1|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
               control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))

bm_null <- brm(click ~ 1 + (trialnr|subjid), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 6000, 
                              chains = 4, 
                              cores  = 4,
               control = list(adapt_delta = 0.95),
                              backend = "cmdstanr")%>%
  add_criterion(., c("waic","loo"))


loo_compare(bm_null,
            bm_co,
            #bm_ntc,
            #bm_nage,
            #bm_base,
            #bm_int,
            bm_id,
            #bm_int_id, 
            criterion = "waic")%>%as_tibble(rownames = "model")%>%left_join(
model_weights(bm_null,
            bm_co,
            #bm_ntc,
            #bm_nage,
            #bm_base,
            #bm_int,
            bm_id,
            #bm_int_id, 
            weights = "waic")%>%as_tibble(rownames = "model")%>%rename(waic_weight = value))

```

```{r}
plot(bm_id)

pp_check(bm_id)

```


```{r}
ndata <- mdata%>%
  distinct(community)%>%
  expand_grid(ageinyears = unique(mdata$ageinyears))%>%
  expand_grid(targetcentralityx = c(min(mdata$targetcentralityx),max(mdata$targetcentralityx)))


post <- fitted(bm_id, newdata = ndata, re_formula =~(ageinyears|community))%>%
  as_tibble() %>%
  bind_cols(ndata)%>%
  mutate(ageinyears = ageinyears + mean(data$ageinyears),
         targetcentralityx = factor(targetcentralityx, labels = c("middle","edge")))


ggplot()+
  geom_smooth(data = post, aes(x = ageinyears, y = Estimate, ymin = Q2.5, ymax = Q97.5, fill =community, col = community), stat = "identity", alpha = .25)+
  theme_bw()+
  scale_color_ptol(name = "Community")+
  scale_fill_ptol(name = "Community")+
  facet_grid(~targetcentralityx)+
  labs(x = "Age", y="Imprecision")


range(mdata$targetcentralityx)
```


```{r}
ps <- bm_id%>%posterior_samples()%>%
  select("b_Intercept", "b_ageinyears",starts_with("r_community"))%>%
  pivot_longer(cols = c(3:10), names_to = "site", values_to = "value")%>%
  mutate(type = ifelse(grepl("Intercept", site), "intercept", "age"),
         site= str_remove(site,"r_community"),
         site= str_remove(site,"Intercept"),
         site= str_remove(site,"ageinyears"),
         site= str_remove(site,"\\["),
         site= str_remove(site,"\\]"),
         site= str_remove(site,"\\,"))%>%
  pivot_longer(cols = c(b_Intercept, b_ageinyears), names_to = "fix_param", values_to = "fix_value")%>%
  mutate(fix_param= tolower(str_remove(fix_param,"b_")),
         fix_param = ifelse(fix_param == "ageinyears", "age", fix_param))%>%
  filter(type == fix_param)%>%
  mutate(est = value + fix_value)

ggplot(ps,aes(y = site, x = est)) +
 stat_halfeye(alpha = .7, .width = c(.95, .80)) +
    labs(x = "Posterior estimate", y ="")+
  guides(fill = "none")+
  facet_grid(~type, scales = "free_x")+
  #geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw()
```



```{r}
bm_screen <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx  + (1|subjid) + (screen + children + household|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_touch <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + (1|subjid) + (1|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))


```

```{r}
ps <- bm_screen%>%posterior_samples()%>%
  select(starts_with("r_community"))%>%
  pivot_longer(cols = everything(), names_to = "param", values_to = "value")%>%
  filter(grepl("Intercept", param))

ggplot(ps,aes(y = param, x = value)) +
 stat_halfeye(alpha = .7, .width = c(.95, .80)) +
    labs(x = "Posterior estimate", y ="")+
  guides(fill = "none")+
  #geom_vline(xintercept = 0, linetype = "dashed") +
  xlim(-0.2, 0.5)+
  theme_minimal()
```


```{r}
bm_child <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + children + (trialnr|subjid), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_young <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + youngerchildren + (trialnr|subjid), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))
```

# Explore response distributions

```{r}
bm_gam <- brm(click ~ 1, 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_log <- brm(abs(clickdistfromtargetcenterx) ~ 1, 
                              data   = mdata, 
                              family = lognormal(),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_slog <- brm(abs(clickdistfromtargetcenterx) ~ 1, 
                              data   = mdata, 
                              family = shifted_lognormal(),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_exg<- brm(abs(clickdistfromtargetcenterx) ~ 1, 
                              data   = mdata, 
                              family = exgaussian(),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_wei<- brm(abs(clickdistfromtargetcenterx) ~ 1, 
                              data   = mdata, 
                              family = weibull(),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))


loo_compare(bm_gam, bm_log,bm_slog, bm_exg,bm_wei)%>%as_tibble(rownames = "model")

pp_check(bm_gam)+xlim(0,3000)
pp_check(bm_log)+xlim(0,3000)
pp_check(bm_slog)+xlim(0,3000)
pp_check(bm_exg)+xlim(0,3000)
pp_check(bm_wei)+xlim(0,3000)
```

```{r}
bm_base_gam <- brm(abs(clickdistfromtargetcenterx) ~ targetcentralityx + (trialnr|subjid) + (0+ageinyears|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 2000, 
                              iter   = 4000,
                   control = list(adapt_delta = 0.99),
                              chains = 8, 
                              cores  = 8)%>%
  add_criterion(., c("waic","loo"))

bm_base_wei <- brm(abs(clickdistfromtargetcenterx) ~ targetcentralityx + (trialnr|subjid) + (0+ageinyears|community), 
                              data   = mdata, 
                              family = weibull(),
                              warmup = 2000, 
                              iter   = 4000, 
                   control = list(adapt_delta = 0.95),
                              chains = 8, 
                              cores  = 8)%>%
  add_criterion(., c("waic","loo"))

loo_compare(bm_base_gam,bm_base_wei)%>%as_tibble(rownames = "model")

pp_check(bm_base_gam)+xlim(0,3000)
pp_check(bm_base_wei)+xlim(0,3000)

plot(bm_base_wei)

```

```{r}
ps <- bm_base_wei%>%posterior_samples()%>%
  select(starts_with("r_community"))%>%
  pivot_longer(cols = everything(), names_to = "param", values_to = "value")%>%
  filter(grepl("1", param))

ggplot(ps,aes(y = param, x = value)) +
 stat_halfeye(alpha = .7, .width = c(.95, .80)) +
    labs(x = "Posterior estimate", y ="")+
  guides(fill = "none")+
  #geom_vline(xintercept = 0, linetype = "dashed") +
  #xlim(-0.2, 0.5)+
  theme_minimal()

```