---
title: "Gafo-cc-analysis"
output: html_document
date: '2022-03-26'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(brms)
library(tidybayes)
```


```{r}
mdata <- read_csv("../data/gafo-cc-clean-data.csv")%>%
  mutate(ageinyears = scale(ageinyears),
         targetcentralityx = scale(targetcentralityx),
         trialnr = scale(trialnr),
         children = scale(children),
         household = scale(household),
         youngerchildren = scale(youngerchildren),
         touchscreen = factor(touchscreen),
        screen = factor(screen))

unique(mdata$community)
```

```{r}
bm_base <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + (trialnr|subjid) + (1|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_null <- brm(abs(clickdistfromtargetcenterx) ~ 1 + (trialnr|subjid)+ (1|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))


loo_compare(bm_base, bm_null)%>%as_tibble(rownames = "model")

```

```{r}
plot(bm_base)

pp_check(bm_base)

bm_age
```

```{r}
ps <- bm_base%>%posterior_samples()%>%
  select(starts_with("r_community"))%>%
  pivot_longer(cols = everything(), names_to = "param", values_to = "value")%>%
  filter(grepl("Intercept", param))

ggplot(ps,aes(y = param, x = value)) +
 stat_halfeye(alpha = .7, .width = c(.95, .80)) +
    labs(x = "Posterior estimate", y ="")+
  guides(fill = "none")+
  #geom_vline(xintercept = 0, linetype = "dashed") +
  xlim(-0.2, 0.5)+
  theme_minimal()
```



```{r}
bm_screen <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx  + (1|subjid) + (screen + children + household|community), 
                              data   = mdata%>%filter(community != "chimfunshi_kumwenda"), 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_touch <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + (1|subjid) + (1|community), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))


```
```{r}
ps <- bm_screen%>%posterior_samples()%>%
  select(starts_with("r_community"))%>%
  pivot_longer(cols = everything(), names_to = "param", values_to = "value")%>%
  filter(grepl("Intercept", param))

ggplot(ps,aes(y = param, x = value)) +
 stat_halfeye(alpha = .7, .width = c(.95, .80)) +
    labs(x = "Posterior estimate", y ="")+
  guides(fill = "none")+
  #geom_vline(xintercept = 0, linetype = "dashed") +
  xlim(-0.2, 0.5)+
  theme_minimal()
```


```{r}
bm_child <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + children + (trialnr|subjid), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))

bm_young <- brm(abs(clickdistfromtargetcenterx) ~ ageinyears  + targetcentralityx + youngerchildren + (trialnr|subjid), 
                              data   = mdata, 
                              family = Gamma(link = "log"),
                              warmup = 1000, 
                              iter   = 4000, 
                              chains = 4, 
                              cores  = 4)%>%
  add_criterion(., c("waic","loo"))
```


