---
title: "Gafo-cc data processing"
output: html_document
---

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(prettyR) # for describe()
library(jsonlite) # for reading in json files
library(stringr)
library(eeptools)
library(lubridate) # for date handling
library(readxl)
library(readODS)
library(truncnorm)

options(scipen = 999)
theme_set(theme_classic())
```

# Namibia

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/namibia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_namibia <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/namibia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_namibia <- bind_rows(raw_data_namibia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_namibia <- raw_data_namibia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = toupper(subjID))%>%select(-touchScreen)#%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)

```

```{r demographics}
raw_demographics_namibia <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Haikom 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("H",str_pad(ID, 7, pad = "0")))%>%mutate(site = Community, Community = "hai||om"),
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Khwe 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("K",str_pad(ID, 7, pad = "0")))%>%rename(Sex = `...7`)%>%mutate(site = Community, Community = "khwe"),
    read_xlsx("../../raw_data/gafo-cc/namibia/Data Windhoek 2022 completed.xlsx", sheet = 1)%>%
    select(ID, Community,`First Name`,Name,	BirthDate,	TestDate,	Sex,	Screen,	Touchscreen,	Household,	Children,	YoungerChildren)%>%mutate(ID = paste0("W",str_pad(ID, 7, pad = "0")))%>%mutate(site = Community, Community = "windhoek")
  )%>%
  filter(!grepl("rop",Comment))

testdates <- tidy_data_namibia%>%
  select(subjID, timestamp)%>%
  mutate(test_date = as.Date(substr(timestamp, 0,10)))%>%
  select(subjID, test_date)%>%
  distinct(subjID, .keep_all = T)%>%
  mutate(subjID = toupper(subjID))

tidy_demographics_namibia <- raw_demographics_namibia %>% 
  rename(subjID = ID)%>%
  left_join(testdates)%>%
  mutate(
    ageInYears = as.numeric(difftime(test_date,BirthDate, units = "days")/365.25),
  ) %>%
  select(-c(`First Name`, Name, BirthDate, TestDate,test_date, Comment))%>% 
  rename_all(tolower)%>%
  filter(!is.na(ageinyears))
```

```{r}
data_namibia <- tidy_demographics_namibia%>%
  left_join(tidy_data_namibia%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = T)

```

```{r}
data_namibia%>%
  filter(community == "windhoek")%>%
  mutate(age_group = substr(ageinyears, 1,1))%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

data_namibia%>%
  filter(community == "windhoek")%>%
  group_by(ageinyears)%>%
  summarise(n= n_distinct(subjid))%>%
  ggplot(aes(x = ageinyears, y = ""))+
  geom_count(alpha = .5)+
  xlim(2.5, 8)+
  theme_bw()
```


# Leipzig

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-leipzig/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/leipzig/")
```


```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/leipzig/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_leipzig <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/leipzig/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_leipzig <- bind_rows(raw_data_leipzig, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_leipzig <- raw_data_leipzig %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = as.character(subjID),
         subjID = ifelse(subjID == "VcyYgGQx", "VcyYgFQx", subjID),
         subjID = ifelse(subjID == "R9V7qHrx", "R9v7qHrx", subjID),
         subjID = ifelse(subjID == "QZJvSwfQ","QZJvSwftQ",  subjID),
         subjID = ifelse(subjID == "TSPeVFYf", "tSPeVFYf", subjID),
         subjID =as.factor(subjID))%>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)
```


```{r demographics}
raw_demographics_leipzig <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/docs/Gafo-cc-leipzig-participants.xlsx", sheet = 1)
  #read_xlsx("../../raw_data/gafo-cc/leipzig/Gafo-cc-leipzig-participants.xlsx", sheet = 1)
  )

tidy_demographics_leipzig <- raw_demographics_leipzig %>% 
  mutate(
    test_date = as.Date(test_date, format = "%d/%m/%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  ) %>%
  select(-c(first_name, last_name, id, test_date, birth_date))%>%
  rename(subjid = code)%>%
  filter(status == "keep")
```

```{r}
tidy_demographics_leipzig%>%
  filter(!subjid %in% tidy_data_leipzig$subjID)
```


```{r}
data_leipzig <- tidy_demographics_leipzig%>%
  left_join(tidy_data_leipzig%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

```

```{r}
data_leipzig%>%
  group_by(subjid)%>%
  summarise(n())

data_leipzig%>%
  #group_by(subjid)%>%
  summarise(n = n_distinct(subjid))
  

data_leipzig%>%
  mutate(age_group = substr(ageinyears, 1, 1))%>%
  select(subjid, sex, age_group, screen, touchscreen, household, children, younger_children)%>%
  na.omit()%>%
  group_by(age_group, sex)%>%
  summarise(n = n_distinct(subjid))


data_leipzig%>%
  mutate(age_group = substr(ageinyears, 1, 1))%>%
  select(subjid, sex, age_group, screen, touchscreen, household, children, younger_children)%>%
  na.omit()%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))
```

# Nigeria

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_nigeria <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_nigeria <- bind_rows(raw_data_nigeria, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_nigeria <- raw_data_nigeria %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = as.character(subjID),
    subjID = ifelse(subjID == "nlger002", "niger002", subjID)
  ) %>%select(-touchScreen)#%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r demographics}
raw_demographics_nigeria <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/gafo-cc-nigeria-participants.xlsx", sheet = 1)
  )

tidy_demographics_nigeria <- raw_demographics_nigeria %>% 
  filter(community!= "leipzig")%>%
  mutate(
    birth_date = ifelse(birth_date == "10.11.1016", "10.11.2016", birth_date),
    test_date = as.Date(test_date, format = "%d.%m.%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, `...14`, `...15`, comment))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```



```{r}
data_nigeria <- tidy_demographics_nigeria%>%
  left_join(tidy_data_nigeria%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(location = community,
         community = "akure")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)
```

# Zambia

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/zambia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_zambia <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/zambia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_zambia <- bind_rows(raw_data_zambia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_zambia <- raw_data_zambia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = paste0("z", subjID),
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_zambia%>%
  summarise(n = n_distinct(subjID))
```


```{r demographics}
raw_demographics_zambia <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/zambia/Gafo_cc_Zambia_April23_Final.xlsx", sheet = 1)
  )

tidy_demographics_zambia <- raw_demographics_zambia %>% 
  filter(community!= "leipzig")%>%
  mutate(
    #test_date = as.Date(test_date, format = "%d/%m/%Y"),
    #birth_date = as.Date(birth_date, format = "%d/%m/%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    id = paste0("z", id),
    screen = ifelse(screen == "yes", 1, 0),
    touchscreen = ifelse(touchscreen == "yes", 1, 0)
  )  %>%
  filter(status == "keep")%>%
  select(-c(test_date, birth_date, comment, Age, consent_signed, Nr, status))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```

```{r}
data_zambia <- tidy_demographics_zambia%>%
  left_join(tidy_data_zambia%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "chimfunshi")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)
```

# Stanford

```{r}
data_stanford <- read.csv("../../raw_data/gafo-cc/stanford/tidy_data_extra.csv")%>%
  mutate(subjID = paste0("S",subjID),
         community = "stanford",
         screen = ifelse(screen == "yes", 1, 0),
         touchscreen = ifelse(touchscreen == "yes", 1, 0),
         browserVersion = factor(browserVersion),
         targetPosition = factor(targetPosition))%>%
  select(-touchScreen)%>%
  rename(ageinyears = age)%>%
  rename_all(tolower)%>%
  distinct(subjid, trialnr, .keep_all = T)
```

```{r}
data_stanford%>%
  mutate(age_group = substr(ageinyears, 1,1))%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

```






# Plymouth

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-uk/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/plymouth/")
```

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/plymouth/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_plymouth <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/plymouth/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_plymouth <- bind_rows(raw_data_plymouth, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_plymouth <- raw_data_plymouth %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID =as.factor(subjID))%>%select(-touchScreen)%>%
  distinct(subjID, trialNr, .keep_all = T)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)
```

```{r}
tidy_data_plymouth%>%
  filter(trialType == "test")%>%
  group_by(subjID)%>%
  summarise(n = n())

tidy_data_plymouth%>%
  filter(trialType == "test")%>%
  summarise(n = n_distinct(subjID))
```

```{r demographics}
raw_demographics_plymouth <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/plymouth/participants_information.xlsx", sheet = 1)
  )

test_date_plymouth <- tidy_data_plymouth%>%
  select(subjID, timestamp)%>%
  mutate(test_date = as.Date(substr(timestamp, 1,10),format = "%Y-%m-%d"))%>%
  select(-timestamp)%>%
  rename_all(tolower)

tidy_demographics_plymouth <- raw_demographics_plymouth %>% 
  select(-test_date)%>%
  left_join(test_date_plymouth)%>%
  mutate(
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    younger_children = ifelse(younger_children == "N/A", NA, younger_children),
    younger_children = as.numeric(younger_children)
  )  %>%
  select(-c(test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))
```
```{r}
data_plymouth <- tidy_demographics_plymouth%>%
  left_join(tidy_data_plymouth%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_plymouth%>%
  #mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

data_plymouth%>%
  group_by(subjid)%>%
  summarise(n())


  
```


# Mexico

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_mex <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_mex <- bind_rows(raw_data_mex, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_mex <- raw_data_mex %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali")
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_mex%>%
  summarise(n = n_distinct(subjID))
```


```{r demographics}
raw_demographics_mex <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/participants.xlsx", sheet = 1)
  )%>%
  filter(!is.na(lastname))%>%
  mutate(birth_date = ifelse(birth_date == 29042017, 20170429, birth_date))

tidy_demographics_mex <- raw_demographics_mex %>% 
  mutate(
    
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(name, lastname, test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))

```

```{r}
data_mex <- tidy_demographics_mex%>%
  left_join(tidy_data_mex%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "mexico")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_mex%>%summarise(n = n_distinct(subjid))
```


# China

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-china/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/china/")
```

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/china/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_china <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/china/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_china <- bind_rows(raw_data_china, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_china <- raw_data_china %>%
  
  # convert all character vectors into factors
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = ifelse(grepl("2023-04-13T03:1", timestamp), "china075", subjID),
         subjID = ifelse(grepl("2023-04-13T07:0", timestamp), "china077", subjID))%>%
  select(-touchScreen)%>%
  distinct(subjID, trialNr, .keep_all = T)%>%
   mutate_if(is.character, as.factor)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)

tidy_data_china%>%
  filter(subjID == "china077")

```

```{r demographics}
raw_demographics_china <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/china/gafo-cc-participants_China_0421.xlsx", sheet = 1, 
            col_types = c("text", "text", "text", "skip", "skip", "skip", "date", "date", "numeric", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))
  )%>%
  filter(!row_number() == 1)

tidy_demographics_china <- raw_demographics_china %>% 
  mutate(
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25)
  )  %>%
  select(-c(test_date, birth_date, comment))%>%
  filter(status == "included", 
         !is.na(ageinyears))%>%
  select(-status)%>%
  rename(subjid = id)

tidy_demographics_china%>%
  arrange(ageinyears)
```

```{r}
data_china <- tidy_demographics_china%>%
  left_join(tidy_data_china%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_china%>%
  #mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

data_china%>%
  group_by(subjid)%>%
  summarise(n())


  
```

# Merge
```{r}

data <- bind_rows(
  data_zambia,
  data_namibia%>%rename(younger_children = youngerchildren),
  data_leipzig,
  data_nigeria,
  data_plymouth,
  data_stanford,
  data_mex,
  data_china
)%>%
  #mutate(community = paste0("c",as.character(as.numeric(as.factor(community)))))%>%
  filter(trialtype == "test")%>%
  mutate(age_group = substr(ageinyears, 1,1))

write_csv(data,"../data/gafo-cc-clean-data.csv")


data%>%
  filter(touchscreen == 2)
```


```{r}
data_plymouth%>%
  summarise(n= n_distinct(subjid))

data%>%
  group_by(community)%>%
  summarise(n= n_distinct(subjid))
```


```{r}
data%>%
  select(-touchscreen)%>%
  filter(community == "windhoek")%>%
  rename(touchscreen = touchscreen.x)%>%
  group_by(subjid, community, sex, screen, touchscreen, household,children,younger_children, ageinyears)%>%
    summarise(precision = mean(abs(clickdistfromtargetcenterx)))%>%
  write_csv(.,"../data/gafo-cc-windhoek.csv")
```


# Data for model 

```{r}

data <- read_csv("../data/gafo-cc-clean-data.csv")

mdata <- data%>%
  filter(community != "chimfunshi",
         voiceover == F)%>%
  mutate(agecentered = ageinyears - min(ageinyears))%>%
  select(-c(sex,ageinyears, wrongareaclick, earlyclick, durationanimationballoontotal, durationanimationcomplete, responsetime, clientscreenwidth, clientscreenheight, clientscreenscaling, clickoriginalx, clickoriginaly, hitbbtargetx, hitbbtargety, clickdistfromtargetbboxx, clickedarea, studyversion, boxesnr,population, inhouse, os, mobile, browser, browserversion, safari, iossafari,target, voiceover, epoch, timestamp, inwardclick, boxwidth,boxborderleft, boxborderright , correctbox, datacollection, sample, studytype, comment, status, site, `phone number in DB`,`location` ))

write(toJSON(mdata), file = "../model/model_data/gafo-cc-model-data.json")

write_csv(mdata, file = "../model/model_data/gafo-cc-model-data.csv")

display(communities)%>%
  filter(is.na(community))

mdata%>%
  filter(trialnr == 5)%>%
  select(subjid,agecentered)

range(mdata$clickscaledx+500)
```

```{r}
mdata_small <- mdata%>%
  filter(subjid %in% c("VcyYgFQx", "k1mQYc2K", "niger007","niger057"))
  

write(toJSON(mdata_small), file = "../model/model_data/gafo-cc-model-data-small.json")
```

```{r}
prior <- dtruncnorm(seq(from = 0, to = 2900, by = 20), a = 1, b = 2920, mean = 1450, sd = 100)

length(prior)

write(toJSON(prior, digits = 4, use_signif = TRUE), file = "../model/model_data/centerBias_extended.json")
```

