---
title: "Gafo-cc data processing"
output: html_document
---

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(prettyR) # for describe()
library(jsonlite) # for reading in json files
library(stringr)
library(eeptools)
library(lubridate) # for date handling
library(readxl)
library(readODS)
library(truncnorm)

options(scipen = 999)
theme_set(theme_classic())
```

# Namibia

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/namibia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_namibia <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/namibia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_namibia <- bind_rows(raw_data_namibia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_namibia <- raw_data_namibia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = toupper(subjID))%>%select(-touchScreen)#%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


unique(tidy_data_namibia$subjID)
```

```{r demographics}
raw_demographics_namibia <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Haikom 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("H",str_pad(ID, 7, pad = "0")))%>%mutate(site = Community, Community = "hai||om"),
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Khwe 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("K",str_pad(ID, 7, pad = "0")))%>%rename(Sex = `...7`)%>%mutate(site = Community, Community = "khwe"),
    read_xlsx("../../raw_data/gafo-cc/namibia/Data Windhoek 2022 completed.xlsx", sheet = 1)%>%
    select(ID, Community,`First Name`,Name,	BirthDate,	TestDate,	Sex,	Screen,	Touchscreen,	Household,	Children,	YoungerChildren)%>%mutate(ID = paste0("W",str_pad(ID, 7, pad = "0")))%>%mutate(site = Community, Community = "windhoek")
  )%>%
  filter(!grepl("rop",Comment))

testdates <- tidy_data_namibia%>%
  select(subjID, timestamp)%>%
  mutate(test_date = as.Date(substr(timestamp, 0,10)))%>%
  select(subjID, test_date)%>%
  distinct(subjID, .keep_all = T)%>%
  mutate(subjID = toupper(subjID))

tidy_demographics_namibia <- raw_demographics_namibia %>% 
  rename(subjID = ID)%>%
  left_join(testdates)%>%
  mutate(
    ageInYears = as.numeric(difftime(test_date,BirthDate, units = "days")/365.25),
  ) %>%
  select(-c(`First Name`, Name, BirthDate, TestDate,test_date, Comment))%>% 
  rename_all(tolower)%>%
  filter(!is.na(ageinyears))
  
```

```{r}
data_namibia <- tidy_demographics_namibia%>%
  left_join(tidy_data_namibia%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = T)

```

```{r}
data_namibia%>%
  filter(community == "windhoek")%>%
  mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

data_namibia%>%
  filter(community == "windhoek")%>%
  group_by(ageinyears)%>%
  summarise(n= n_distinct(subjid))%>%
  ggplot(aes(x = ageinyears, y = ""))+
  geom_count(alpha = .5)+
  xlim(2.5, 8)+
  theme_bw()
```


# Leipzig

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-leipzig/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/leipzig/")
```


```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/leipzig/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_leipzig <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/leipzig/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_leipzig <- bind_rows(raw_data_leipzig, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_leipzig <- raw_data_leipzig %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = as.character(subjID),
         subjID = ifelse(subjID == "VcyYgGQx", "VcyYgFQx", subjID),
         subjID = ifelse(subjID == "R9V7qHrx", "R9v7qHrx", subjID),
         subjID = ifelse(subjID == "QZJvSwfQ","QZJvSwftQ",  subjID),
         subjID = ifelse(subjID == "TSPeVFYf", "tSPeVFYf", subjID),
         subjID =as.factor(subjID))%>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)
```


```{r demographics}
raw_demographics_leipzig <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/docs/Gafo-cc-leipzig-participants.xlsx", sheet = 1)
  #read_xlsx("../../raw_data/gafo-cc/leipzig/Gafo-cc-leipzig-participants.xlsx", sheet = 1)
  )%>%
  mutate(status = ifelse(code == "o9qVPfZD", "keep", status))

tidy_demographics_leipzig <- raw_demographics_leipzig %>% 
  mutate(
    test_date = as.Date(test_date, format = "%d/%m/%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    sex = ifelse(sex == "w", "f", sex)
  ) %>%
  select(-c(first_name, last_name, id, test_date, birth_date))%>%
  rename(subjid = code)%>%
  filter(status == "keep")
```

```{r}
tidy_demographics_leipzig%>%
  filter(!subjid %in% tidy_data_leipzig$subjID)
```


```{r}
data_leipzig <- tidy_demographics_leipzig%>%
  left_join(tidy_data_leipzig%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

```

```{r}
data_leipzig%>%
  group_by(subjid)%>%
  summarise(n())

data_leipzig%>%
  #group_by(subjid)%>%
  summarise(n = n_distinct(subjid))
  

data_leipzig%>%
  mutate(age_group = substr(ageinyears, 1, 1))%>%
  select(subjid, sex, age_group, screen, touchscreen, household, children, younger_children)%>%
  na.omit()%>%
  group_by(age_group, sex)%>%
  summarise(n = n_distinct(subjid))


data_leipzig%>%
  mutate(age_group = substr(ageinyears, 1, 1))%>%
  select(subjid, sex, age_group, screen, touchscreen, household, children, younger_children)%>%
  na.omit()%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))
```

# Nigeria

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_nigeria <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_nigeria <- bind_rows(raw_data_nigeria, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_nigeria <- raw_data_nigeria %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = as.character(subjID),
    subjID = ifelse(subjID == "nlger002", "niger002", subjID)
  ) %>%select(-touchScreen)#%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r demographics}
raw_demographics_nigeria <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/gafo-cc-nigeria-participants.xlsx", sheet = 1)
  )

tidy_demographics_nigeria <- raw_demographics_nigeria %>% 
  filter(community!= "leipzig")%>%
  mutate(
    birth_date = ifelse(birth_date == "10.11.1016", "10.11.2016", birth_date),
    test_date = as.Date(test_date, format = "%d.%m.%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, `...14`, `...15`, comment))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```



```{r}
data_nigeria <- tidy_demographics_nigeria%>%
  left_join(tidy_data_nigeria%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(location = community,
         community = "akure")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)
```

# Zambia

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/zambia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_zambia <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/zambia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_zambia <- bind_rows(raw_data_zambia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_zambia <- raw_data_zambia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = paste0("z", subjID),
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_zambia%>%
  summarise(n = n_distinct(subjID))
```


```{r demographics}
raw_demographics_zambia <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/zambia/Gafo_cc_Zambia_April23_Final.xlsx", sheet = 1)
  )

tidy_demographics_zambia <- raw_demographics_zambia %>% 
  filter(community!= "leipzig")%>%
  mutate(
    #test_date = as.Date(test_date, format = "%d/%m/%Y"),
    #birth_date = as.Date(birth_date, format = "%d/%m/%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    id = paste0("z", id),
    screen = ifelse(screen == "yes", 1, 0),
    touchscreen = ifelse(touchscreen == "yes", 1, 0)
  )  %>%
  filter(status == "keep")%>%
  select(-c(test_date, birth_date, comment, Age, consent_signed, Nr, status))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```

```{r}
data_zambia <- tidy_demographics_zambia%>%
  left_join(tidy_data_zambia%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "chimfunshi")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)
```

# Stanford

```{r}
data_stanford <- read.csv("../../raw_data/gafo-cc/stanford/tidy_data_extra.csv")%>%
  mutate(subjID = paste0("S",subjID),
         community = "stanford",
         screen = ifelse(screen == "yes", 1, 0),
         touchscreen = ifelse(touchscreen == "yes", 1, 0),
         browserVersion = factor(browserVersion),
         targetPosition = factor(targetPosition))%>%
  select(-touchScreen)%>%
  rename(ageinyears = age)%>%
  rename_all(tolower)%>%
  distinct(subjid, trialnr, .keep_all = T)
```

```{r}
data_stanford%>%
  mutate(age_group = substr(ageinyears, 1,1))%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

```






# Plymouth

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-uk/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/plymouth/")
```

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/plymouth/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_plymouth <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/plymouth/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_plymouth <- bind_rows(raw_data_plymouth, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_plymouth <- raw_data_plymouth %>%
  
  # convert all character vectors into factors
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali")
  ) %>%
  mutate(subjID = ifelse(grepl("2023-03-11T19:4", timestamp) & subjID == "uksch048", "uksch049", subjID),
         subjID = ifelse(subjID == "Uksch002", "uksch002", subjID),
         subjID = ifelse(subjID == "Uksch003", "uksch003", subjID))%>%
  mutate(subjID =as.factor(subjID))%>%
  select(-touchScreen)%>%
  mutate_if(is.character, as.factor)%>% 
  distinct(subjID, trialNr, .keep_all = T)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


unique(raw_data_plymouth$subjID)
```

```{r}
tidy_data_plymouth%>%
  filter(trialType == "test")%>%
  group_by(subjID)%>%
  summarise(n = n())

tidy_data_plymouth%>%
  filter(trialType == "test")%>%
  summarise(n = n_distinct(subjID))

tidy_data_plymouth%>%
  filter(subjID == "uksch002")
```

```{r demographics}
raw_demographics_plymouth <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/plymouth/participants_information_updated_2023_May.xlsx", sheet = 1)
  )%>%
  filter(tested == "yes")

test_date_plymouth <- tidy_data_plymouth%>%
  select(subjID, timestamp)%>%
  mutate(test_date = as.Date(substr(timestamp, 1,10),format = "%Y-%m-%d"))%>%
  select(-timestamp)%>%
  rename_all(tolower)%>%
  distinct(subjid, test_date)

tidy_demographics_plymouth <- raw_demographics_plymouth %>% 
  #select(-test_date)%>%
  #left_join(test_date_plymouth)%>%
  mutate(
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    younger_children = ifelse(younger_children == "N/A", NA, younger_children),
    younger_children = as.numeric(younger_children)
  )  %>%
  select(-c(test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))

```

```{r}
data_plymouth <- tidy_demographics_plymouth%>%
  left_join(tidy_data_plymouth%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_plymouth%>%
  #mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age)%>%
  summarise(n = n_distinct(subjid))

data_plymouth%>%
  group_by(age)%>%
  summarise(n())


 data_plymouth%>%
   filter(is.na(durationanimationballoontotal))
```


# Mexico

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_mex <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_mex <- bind_rows(raw_data_mex, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_mex <- raw_data_mex %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali")
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_mex%>%
  summarise(n = n_distinct(subjID))
```


```{r demographics}
raw_demographics_mex <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/mexico/participants.xlsx", sheet = 1)
  )%>%
  filter(!is.na(lastname))%>%
  mutate(birth_date = ifelse(birth_date == 29042017, 20170429, birth_date))

tidy_demographics_mex <- raw_demographics_mex %>% 
  mutate(
    
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(name, lastname, test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))

```

```{r}
data_mex <- tidy_demographics_mex%>%
  left_join(tidy_data_mex%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "mexico")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_mex%>%summarise(n = n_distinct(subjid))

```
```{r}
# data_liz <- bind_rows(data_mex%>%
#   filter(trialtype == "test", voiceover == F)%>%
#   mutate(click_distance = abs(clickdistfromtargetcenterx))%>%
#   select("subjid" ,"community" ,"ageinyears" , "trialnr", "targetposition",  "click_distance", "sex", "economical_activity_dad" , "economical_activity_mom"   ,    "parents_education_level_dad"  , "parents_education_level_mom" ,  "income" ,    "screen"           ,             "touchscreen"       ,            "household"     ,                "children" ,
#         "younger_children"),
# 
# data_leipzig%>%
#   filter(trialtype == "test", voiceover == F)%>%
#   mutate(click_distance = abs(clickdistfromtargetcenterx))%>%
#   select("subjid" ,"community" ,"ageinyears" , "trialnr", "targetposition",  "click_distance", "sex", "screen"           ,             "touchscreen"       ,            "household"     ,                "children" ,
#         "younger_children")
# )
# 
# 
#   write_csv(data_liz, "../data/gafo-cc-data-lizbeth.csv")
#   
# 
# data_liz <- read_csv("gafo-cc-data-lizbeth.csv")
# 
# 
# data_liz_agg <- data_liz%>%
#   group_by(subjid, community, ageinyears, sex, economical_activity_dad, economical_activity_mom, parents_education_level_dad, parents_education_level_mom, income, screen, touchscreen, household, children, younger_children)%>%
#   summarise(mean_distance = mean(click_distance))%>% # aggregate data to get average click distance
#   ungroup()%>%
#   mutate(mean_distance_scale = scale(mean_distance, scale = F, center = T), # make the DV so that it has a mean of 0
#          z_ageinyears = scale(ageinyears, scale = F, center = T), # scale numeric variables
#          f_income = factor(income),# convert numeric variable into a factor because different values represent different categories
#          z_household = scale(household)) 
# 
# 
# library(lme4)
# 
# m1 <- lm(mean_distance_scale ~ z_ageinyears + community, data = data_liz_agg)
# 
# drop1(m1, test = "Chisq") # to get p-values for entire factors you need to use drop1
# 
# summary(m1)
```


# China

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-china/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/china/")
```

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/china/", pattern = "*.json",recursive = T)%>% str_subset(pattern = "gafo--", negate = T)

# convert json files to tibbles
raw_data_china <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/china/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_china <- bind_rows(raw_data_china, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_china <- raw_data_china %>%
  
  # convert all character vectors into factors
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = ifelse(grepl("2023-04-13T03:1", timestamp), "china075", subjID),
         subjID = ifelse(grepl("2023-04-13T07:0", timestamp), "china077", subjID))%>%
  select(-touchScreen)%>%
  distinct(subjID, trialNr, .keep_all = T)%>%
   mutate_if(is.character, as.factor)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)

tidy_data_china%>%
  filter(subjID == "china077")

n_distinct(tidy_data_china$subjID)

tidy_data_china%>%
  group_by(subjID)%>%
  summarise(n())
```

```{r demographics}
raw_demographics_china <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/china/gafo-cc-participants_China_0608_final_updated.xlsx", sheet = 1, 
            col_types = c("text", "text", "text", "skip", "skip", "skip", "date", "date", "numeric", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))
  )%>%
  filter(!row_number() == 1)

tidy_demographics_china <- raw_demographics_china %>% 
  mutate(
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25)
  )  %>%
  select(-c(test_date, birth_date, comment))%>%
  filter(status == "included", 
         !is.na(ageinyears))%>%
  select(-status)%>%
  rename(subjid = id)

tidy_demographics_china%>%
  arrange(ageinyears)
```

```{r}
data_china <- tidy_demographics_china%>%
  left_join(tidy_data_china%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_china%>%
  #mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

data_china%>%
  group_by(subjid)%>%
  summarise(n())


  
```

# Argentina

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/argentina/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_arg <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/argentina/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_arg <- bind_rows(raw_data_arg, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_arg <- raw_data_arg %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_arg%>%
  summarise(n = n_distinct(subjID))

tidy_data_arg%>%
  group_by(subjID)%>%
  summarise(n = n())
```


```{r demographics}
raw_demographics_arg <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/argentina/gafo-cc-arg-participants.xlsx", sheet = 1, 
            col_types = c("text", "text", "text", "text", "date", "date", "text", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))
  )

tidy_demographics_arg <- raw_demographics_arg %>% 
  filter(Status== "keep")%>%
  mutate(
    test_date = as.Date(test_date, format = "%d/%m/%Y"),
    birth_date = as.Date(birth_date, format = "%d/%m/%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25)
  )  %>%
  #filter(status == "keep")%>%
  select(-c(test_date, birth_date, comment, Edad))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))%>%
  mutate(touchscreen = as.numeric(touchscreen),
         household = as.numeric(household),
         children = as.numeric(children),
         younger_children = as.numeric(younger_children))

tidy_demographics_arg%>%
  filter(ageinyears < 2)
```

```{r}
raw_demographics_arg%>%
  filter(!id %in% tidy_data_arg$subjID)


tidy_data_arg%>%
  filter(!subjID %in% raw_demographics_arg$id)
```



```{r}
data_arg <- tidy_demographics_arg%>%
  left_join(tidy_data_arg%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "buenos_aires")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_arg%>%
  group_by(community)%>%
  summarise(n = n_distinct(subjid))

data_arg%>%
  group_by(subjid)%>%
  summarise(n = n())
```

# India

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/india/Data/India_Data/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_ind <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/india/Data/India_Data/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_ind <- bind_rows(raw_data_ind, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_ind <- raw_data_ind %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_ind%>%
  summarise(n = n_distinct(subjID))

tidy_data_ind%>%
  group_by(subjID)%>%
  summarise(n = n())


```

```{r }
raw_demographics_ind <- read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/india/gafo-cc-india-participants.xlsx", sheet = 1)

tidy_demographics_ind <- raw_demographics_ind %>% 
  mutate(
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))%>%
  rename(subjid = id)

```

```{r}
data_ind <- tidy_demographics_ind%>%
  left_join(tidy_data_ind%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "india")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_ind%>%
  group_by(subjid)%>%
  summarise(n = n())

```

# Auckland

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-newzealand/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/auckland/")
```

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/new_zealand/data/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_nz <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/new_zealand/data/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_nz <- bind_rows(raw_data_nz, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_nz <- raw_data_nz %>%
  
  # convert all character vectors into factors
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali")
  ) %>%
  mutate(subjID = ifelse(grepl("2023-03-11T19:4", timestamp) & subjID == "uksch048", "uksch049", subjID),
         subjID = ifelse(subjID == "Uksch002", "uksch002", subjID),
         subjID = ifelse(subjID == "Uksch003", "uksch003", subjID))%>%
  mutate(subjID =as.factor(subjID))%>%
  select(-touchScreen)%>%
  mutate_if(is.character, as.factor)%>% 
  distinct(subjID, trialNr, .keep_all = T)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


unique(tidy_data_nz$subjID)
```

```{r}
tidy_data_nz%>%
  #filter(trialType == "test")%>%
  group_by(subjID)%>%
  summarise(n = n())

tidy_data_nz%>%
  filter(trialType == "test")%>%
  summarise(n = n_distinct(subjID))

tidy_data_nz%>%
  filter(subjID == "uksch002")
```

```{r demographics}
raw_demographics_nz <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/new_zealand/gafo-cc-new-zealand-participants.xlsx", sheet = 1)
  )

tidy_demographics_nz <- raw_demographics_nz %>% 
  mutate(
    
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, comment))%>%
  filter(!is.na(ageinyears))%>%
  rename(subjid = id)

```

```{r}
data_nz <- tidy_demographics_nz%>%
  filter(subjid != "NZ000001")%>%
  left_join(tidy_data_nz%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_nz%>%
  #mutate(age_group = substr(ageinyears, 1,1))%>%
  #group_by(age)%>%
  summarise(n = n_distinct(subjid))

# data_nz%>%
#   group_by(age)%>%
#   summarise(n())
```

# Turkey

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/turkey/data/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_tur <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/turkey/data/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_tur <- bind_rows(raw_data_tur, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_tur <- raw_data_tur %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = as.character(subjID),
    subjID = ifelse(subjID == "TUR79000", "TUR00079",subjID),
    subjID = ifelse(subjID == "TUR80000", "TUR00080",subjID),
    subjID = ifelse(subjID == "TUR81000", "TUR00081",subjID),
    subjID = ifelse(subjID == "TUR83000", "TUR00083",subjID),
    subjID = ifelse(subjID == "TUR84000", "TUR00084",subjID),
    subjID = ifelse(subjID == "TUR85000", "TUR00085",subjID)
  ) %>%select(-touchScreen)%>%
  mutate(subjID = factor(subjID))#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_tur%>%
  summarise(n = n_distinct(subjID))

tidy_data_tur%>%
  group_by(subjID)%>%
  summarise(n = n())

unique(tidy_data_tur$subjID)
```

```{r }
raw_demographics_tur <- read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/turkey/gafo-cc-turkey-participants.xlsx", sheet = 1)

tidy_demographics_tur <- raw_demographics_tur %>% 
  mutate(
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, comment))%>%
  #filter(!is.na(ageinyears))%>%
  rename(subjid = id)

```

```{r}
data_tur <- tidy_demographics_tur%>%
  left_join(tidy_data_tur%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "turkey")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)%>%
  mutate(subjid = recode(subjid, 
                     "EBRAR100" = "TUR00001",
                     "FATMA400" = "TUR00002",
                     "ASYAA200" = "TUR00003"))

data_tur%>%
  group_by(subjid)%>%
  summarise(n = n())

data_tur%>%
  mutate(age_group = substr(ageinyears, 1,1))%>%
  group_by(age_group)%>%
  summarise(n = n_distinct(subjid))

```

# Congo

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/congo/data_GaFo/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_cong <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/congo/data_GaFo/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_cong <- bind_rows(raw_data_cong, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_cong <- raw_data_cong %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
  ) %>%select(-touchScreen)#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_cong%>%
  summarise(n = n_distinct(subjID))

tidy_data_cong%>%
  group_by(subjID)%>%
  summarise(n = n())


```

```{r }
raw_demographics_cong <- bind_rows(
    read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/congo/gafo-cc-congo-participants_2023_V3.xlsx", sheet = 1)%>%
      mutate(household = as.character(household),
             children = as.character(children),
             younger_children = as.character(younger_children)),
    read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/congo/gafo-cc-congo-participants_2023_V3.xlsx", sheet = 2),
  )

tidy_demographics_cong <- raw_demographics_cong %>%
  filter(birth_date != "NA")%>%
  filter(status == "keep", id != "BD000001", id != "BY000001")%>%
  mutate(
    test_date = as.Date(as.character(test_date), format = "%Y%m%d"),
    birth_date = as.Date(as.character(birth_date), format = "%Y%m%d"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
    screen = ifelse(screen == "fallaci", 0, 1), 
    touchscreen = ifelse(touchscreen == "fallaci", 0, 1),
    household = as.numeric(household), 
    children = as.numeric(children),
    younger_children = as.numeric(younger_children)
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, comment))%>%
  #filter(!is.na(ageinyears))%>%
  rename(subjid = id)

```

```{r}
data_cong <- tidy_demographics_cong%>%
  left_join(tidy_data_cong%>%rename_all(tolower),by = c("subjid"))%>%
  #mutate(community = "congo")%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

data_cong%>%
  group_by(subjid)%>%
  summarise(n = n())

data_cong%>%
  group_by(subjid)%>%
  summarise(n = n(), 
            mean = mean(abs(clickdistfromtargetcenterx)))

```
# Merge
```{r}
merge_raw_data <- bind_rows(
  data_zambia,
  data_namibia%>%rename(younger_children = youngerchildren),
  data_leipzig,
  data_nigeria,
  data_plymouth,
  data_stanford,
  data_mex,
  data_china, 
  data_arg,
  data_ind,
  data_nz, 
  data_tur,
  data_cong
)%>%
  #mutate(community = paste0("c",as.character(as.numeric(as.factor(community)))))%>%
  filter(trialtype == "test",
         voiceover == F
         )%>%
  mutate(age_group = substr(ageinyears, 1,1), 
         trialnr = as.numeric(factor(trialnr)))

write_csv(merge_raw_data,"../data/gafo-cc-raw-data.csv")

data <- merge_raw_data%>%
  select(subjid, community, age_group, ageinyears, sex, screen, touchscreen, household, children, younger_children, trialnr, targetposition,targetcenterx, targetcentralityx, clickdistfromtargetcenterx)%>%
  filter(ageinyears > 1)

write_csv(data,"../data/gafo-cc-clean-data.csv")


methods_data <- merge_raw_data%>%
  select(subjid, community, age_group, ageinyears, trialnr, targetposition,targetcentralityx, clickdistfromtargetcenterx)%>%
  filter(ageinyears > 1)

write_csv(methods_data,"../../tango-cc-methods/data/data.csv")
```

```{r}
fam_excl <- bind_rows(
  data_zambia,
  data_namibia%>%rename(younger_children = youngerchildren),
  data_leipzig,
  data_nigeria,
  data_plymouth,
  data_stanford,
  data_mex,
  data_china, 
  data_arg,
  data_ind,
  data_nz, 
  data_tur,
  data_cong
)%>%
  filter(trialtype != "test")%>%
  group_by(subjid,community)%>%
  mutate(click = abs(clickdistfromtargetcenterx))%>%
  summarise(mean_click = mean(click))%>%
  filter(mean_click > 100)%>%
  pull(subjid)
```


```{r}
data <- read_csv("../data/gafo-cc-clean-data.csv")

data%>%
  #group_by(community)%>%
  summarise(n = n_distinct(subjid))

data%>%
  filter(touchscreen == 2)%>%
  distinct(subjid)

unique(data$screen)

unique(data$touchscreen)

unique(data$household)

unique(data$children)

unique(data$younger_children)
```



```{r}
data_arg%>%
  summarise(n= n_distinct(subjid))

data%>%
  group_by(community)%>%
  summarise(n= n_distinct(subjid))
```


```{r}
data%>%
  #select(-touchscreen)%>%
  filter(community == "hai||om" | community == "plymouth")%>%
  #rename(touchscreen = touchscreen.x)%>%
  group_by(subjid, community, sex, screen, touchscreen, household,children,younger_children, ageinyears)%>%
    summarise(precision = mean(abs(clickdistfromtargetcenterx)))%>%
  write_csv(.,"../data/gafo-cc-uk-namibia.csv")
```


# Data for model 

```{r}

communities <- unique(merge_raw_data$community)

for (i in communities) {
  
m_data <- merge_raw_data%>%
  filter(community == i,
         voiceover == F)%>%
  mutate(agecentered = ageinyears - min(ageinyears))%>%
  select(-c(sex,ageinyears, wrongareaclick, earlyclick, durationanimationballoontotal, durationanimationcomplete, responsetime, clientscreenwidth, clientscreenheight, clientscreenscaling, clickoriginalx, clickoriginaly, hitbbtargetx, hitbbtargety, clickdistfromtargetbboxx, clickedarea, studyversion, boxesnr,population, inhouse, os, mobile, browser, browserversion, safari, iossafari,target, voiceover, epoch, timestamp, inwardclick, boxwidth,boxborderleft, boxborderright , correctbox, datacollection, sample, studytype, comment, status, site,`location` ))

write(toJSON(m_data), file = paste0("../model/model_data/", i, "-model-data.json"))

#write_csv(mdata, file = "../model/model_data/", i, "-model-data.csv")

}



```


```{r}
mdata_small <- mdata%>%
  filter(subjid %in% c("VcyYgFQx", "k1mQYc2K", "niger007","niger057"))
  

write(toJSON(mdata_small), file = "../model/model_data/gafo-cc-model-data-small.json")
```

```{r}
prior <- dtruncnorm(seq(from = 0, to = 2900, by = 20), a = 1, b = 2920, mean = 1450, sd = 100)

length(prior)

write(toJSON(prior, digits = 4, use_signif = TRUE), file = "../model/model_data/centerBias_extended.json")
```

