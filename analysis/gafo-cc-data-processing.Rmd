---
title: "Gafo-cc data processing"
output: html_document
---

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(prettyR) # for describe()
library(jsonlite) # for reading in json files
library(stringr)
library(eeptools)
library(lubridate) # for date handling
library(readxl)
library(readODS)
library(truncnorm)

options(scipen = 999)
theme_set(theme_classic())
```

# Namibia

```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/namibia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_namibia <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/namibia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_namibia <- bind_rows(raw_data_namibia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_namibia <- raw_data_namibia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) #%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)

```

```{r demographics}
raw_demographics_namibia <- bind_rows(
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Haikom 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("H",str_pad(ID, 7, pad = "0")))%>%mutate(site = Community, Community = "hai||om"),
  read_xlsx("../../raw_data/gafo-cc/namibia/Data Khwe 2022.xlsx", sheet = 1, col_types = c("numeric", "text", "text", "text", "date", "date", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text"))%>%mutate(ID = paste0("K",str_pad(ID, 7, pad = "0")))%>%rename(Sex = `...7`)%>%mutate(site = Community, Community = "khwe")
  )%>%
  filter(!grepl("rop",Comment))

tidy_demographics_namibia <- raw_demographics_namibia %>% 
  mutate(
    ageInYears = as.numeric(difftime(TestDate,BirthDate, units = "days")/365.25),
  ) %>%
  rename(subjID = ID) %>% 
  select(-c(`First Name`, Name, BirthDate, TestDate, Comment))%>% 
  rename_all(tolower)%>%
  filter(!is.na(ageinyears))
```

```{r}
data_namibia <- tidy_demographics_namibia%>%
  left_join(tidy_data_namibia%>%rename_all(tolower),by = c("subjid"))

```

# Leipzig

```{r}
system("rsync -zaP ccp-odcJ:/srv/ccp-odc/gafo-leipzig/data/ ~/Work/Local/QuantEx/Gafo/raw_data/gafo-cc/leipzig/")
```


```{r read_data}
# get all .json files
files <- list.files("../../raw_data/gafo-cc/leipzig/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_leipzig <- tibble()
for (f in files) {
  jf <- paste("../../raw_data/gafo-cc/leipzig/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_leipzig <- bind_rows(raw_data_leipzig, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_leipzig <- raw_data_leipzig %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"), 
  ) %>%
  mutate(subjID = as.character(subjID),
         subjID = ifelse(subjID == "VcyYgGQx", "VcyYgFQx", subjID),
         subjID = ifelse(subjID == "R9V7qHrx", "R9v7qHrx", subjID),
         subjID = ifelse(subjID == "QZJvSwfQ","QZJvSwftQ",  subjID),
         subjID = ifelse(subjID == "TSPeVFYf", "tSPeVFYf", subjID),
         subjID =as.factor(subjID))#%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)


#unique(tidy_data_leipzig$subjID)
```


```{r demographics}
raw_demographics_leipzig <- bind_rows(
  read_xlsx("../../../../../Cloud/QuantEx/Gafo-cc/docs/Gafo-cc-leipzig-participants.xlsx", sheet = 1)
  )

tidy_demographics_leipzig <- raw_demographics_leipzig %>% 
  mutate(
    test_date = as.Date(test_date, format = "%d/%m/%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  ) %>%
  select(-c(first_name, last_name, id, test_date, birth_date))%>%
  rename(subjid = code)%>%
  filter(!is.na(ageinyears),
         status == "keep")
```

```{r}
tidy_demographics_leipzig%>%
  filter(!subjid %in% tidy_data_leipzig$subjID)
```


```{r}
data_leipzig <- tidy_demographics_leipzig%>%
  left_join(tidy_data_leipzig%>%rename_all(tolower),by = c("subjid"))%>%
  distinct(subjid, trialnr, .keep_all = TRUE)

```

```{r}
data_leipzig%>%
  group_by(subjid)%>%
  summarise(n())
  
```

# Nigeria

```{r read_data}
# get all .json files
files <- list.files("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_nigeria <- tibble()
for (f in files) {
  jf <- paste("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/JSONs/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_nigeria <- bind_rows(raw_data_nigeria, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_nigeria <- raw_data_nigeria %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali"),
    subjID = as.character(subjID),
    subjID = ifelse(subjID == "nlger002", "niger002", subjID)
  ) #%>% select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r demographics}
raw_demographics_nigeria <- bind_rows(
  read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/gafo-cc-nigeria-participants.xlsx", sheet = 1)
  )

read_xlsx("../../../../../../Cloud/QuantEx/Gafo-cc/data/nigeria/gafo-cc-nigeria-participants.xlsx", sheet = 1)

tidy_demographics_nigeria <- raw_demographics_nigeria %>% 
  filter(community!= "leipzig")%>%
  mutate(
    birth_date = ifelse(birth_date == "10.11.1016", "10.11.2016", birth_date),
    test_date = as.Date(test_date, format = "%d.%m.%Y"),
    birth_date = as.Date(birth_date, format = "%d.%m.%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, `...14`, `...15`, comment))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```



```{r}
data_nigeria <- tidy_demographics_nigeria%>%
  left_join(tidy_data_nigeria%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(location = community,
         community = "akure")
```

# Zambia

```{r read_data}
# get all .json files
files <- list.files("../../../../../Cloud/QuantEx/Gafo-cc/data/zambia/", pattern = "*.json",recursive = T)

# convert json files to tibbles
raw_data_zambia <- tibble()
for (f in files) {
  jf <- paste("../../../../../Cloud/QuantEx/Gafo-cc/data/zambia/", f, sep = "")
  jd <- jsonlite::fromJSON(paste(readLines(jf, warn = "FALSE"), collapse = ""))
  
  # needed because hedge trials have numbers, box trials have characters
  jd$targetPosition <- factor(as.character(jd$targetPosition))
  
  raw_data_zambia <- bind_rows(raw_data_zambia, jd)
}
# remove variables that we don't need anymore
rm(f, files, jf, jd)
```

```{r}
tidy_data_zambia <- raw_data_zambia %>%
  
  # convert all character vectors into factors
  mutate_if(is.character, as.factor) %>% 
  
  mutate(
    
    # attention! the SVG coord system starts with 0, 0 in upper left corner
    # we transform the values so that 0, 0 is lower left corner (for plots etc)
    clickScaledY = 1080 - clickScaledY,
    targetY = 1080 - targetY, 
    targetCenterY = 1080 - targetCenterY, 
    eyeCenterRightY = 1080 - eyeCenterRightY,
    eyeCenterLeftY = 1080 - eyeCenterLeftY,
    pupilFinalRightY = 1080 - pupilFinalRightY,
    pupilFinalLeftY = 1080 - pupilFinalLeftY, 
    targetCentralityX = abs(960 - targetCenterX),
    
    # similarly here: in svg coords, negative click distance means up. 
    # here we invert it, so that negative values mean down
    clickDistFromTargetCenterY = clickDistFromTargetCenterY * -1, 
    clickDistFromTargetBBoxY = clickDistFromTargetBBoxY * -1, 
    
    # positive values for inward clicks (i.e.,towards the center), negative for outward clicks
    centralityBias = ifelse(targetCenterX <= 1920/2,
                            clickDistFromTargetCenterX, 
                            clickDistFromTargetCenterX*-1), 
    
    inwardClick = ifelse(centralityBias > 0, TRUE, FALSE), 
    
    # did the participant click on the right box?
    # also for hedge version, here we imagine a box surrounding the target center 
    # this way, we can compare hedge and box version ;) 
    boxWidth = 218, 
    boxBorderLeft = targetCenterX - boxWidth/2, 
    boxBorderRight = targetCenterX + boxWidth/2,
    correctBox = ifelse(boxBorderLeft <= clickScaledX & clickScaledX <= boxBorderRight, TRUE, FALSE), 
    
    datacollection = as.factor("in-person - supervised"), 
    sample = as.factor("na"),
    studytype = as.factor("vali")
  ) #%>%select(subjID, population, trialType, trialNr, targetPosition, targetCentralityX, clickDistFromTargetCenterX)
```

```{r}
tidy_data_zambia%>%
  summarise(n = n_distinct(subjID))
```


```{r demographics}
raw_demographics_zambia <- bind_rows(
  read_ods("../../../../../Cloud/QuantEx/Gafo-cc/data/zambia/gafo-cc-sambia-participants.ods", sheet = 1)
  )

tidy_demographics_zambia <- raw_demographics_zambia %>% 
  filter(community!= "leipzig")%>%
  mutate(
    test_date = as.Date(test_date, format = "%d/%m/%Y"),
    birth_date = as.Date(birth_date, format = "%d/%m/%Y"),
    ageinyears = as.numeric(difftime(test_date,birth_date, units = "days")/365.25),
  )  %>%
  select(-c(first_name, last_name, test_date, birth_date, comment))%>%
  rename(subjid = id)%>%
  filter(!is.na(ageinyears))
```

```{r}
data_zambia <- tidy_demographics_zambia%>%
  left_join(tidy_data_zambia%>%rename_all(tolower),by = c("subjid"))%>%
  mutate(community = "chimfunshi")
```

# Merge
```{r}

data <- bind_rows(
  data_namibia%>%rename(younger_children = youngerchildren),
  data_leipzig,
  data_nigeria,
  data_zambia
)%>%
  #mutate(community = paste0("c",as.character(as.numeric(as.factor(community)))))%>%
  filter(trialtype == "test")


data%>%
  group_by(community)%>%
  summarise(n= n_distinct(subjid))

```

```{r}
write_csv(data,"../data/gafo-cc-clean-data.csv")
```

# Data for model 

```{r}

data <- read_csv("../data/gafo-cc-clean-data.csv")

mdata <- data%>%
  filter(community == "leipzig" | community == "akure",
         voiceover == F)%>%
  mutate(agecentered = ageinyears - min(ageinyears))%>%
  select(-c(screen,touchscreen.x, household, children, younger_children, sex,ageinyears, wrongareaclick, earlyclick, durationanimationballoontotal, durationanimationcomplete, responsetime, clientscreenwidth, clientscreenheight, clientscreenscaling, clickoriginalx, clickoriginaly, hitbbtargetx, hitbbtargety, clickdistfromtargetbboxx, clickedarea, studyversion, boxesnr,population, inhouse, touchscreen.y , os, mobile, browser, browserversion, safari, iossafari,target, voiceover, epoch, timestamp, inwardclick, boxwidth,boxborderleft, boxborderright , correctbox, datacollection, sample, studytype, comment, status, site))

write(toJSON(mdata), file = "../model/model_data/gafo-cc-model-data.json")

display(communities)%>%
  filter(is.na(community))

mdata%>%
  filter(trialnr == 5)%>%
  select(subjid,agecentered)

range(mdata$clickscaledx+500)
```

```{r}
mdata_small <- mdata%>%
  filter(subjid %in% c("VcyYgFQx", "k1mQYc2K", "niger007","niger057"))
  

write(toJSON(mdata_small), file = "../model/model_data/gafo-cc-model-data-small.json")
```

```{r}
prior <- dtruncnorm(seq(from = 0, to = 2900, by = 20), a = 1, b = 2920, mean = 1450, sd = 100)

length(prior)

write(toJSON(prior, digits = 4, use_signif = TRUE), file = "../model/model_data/centerBias_extended.json")
```

